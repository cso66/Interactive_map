<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="./resources/ol.css">
        <link rel="stylesheet" href="resources/fontawesome-all.min.css">
        <link rel="stylesheet" href="./resources/ol-layerswitcher.css">
        <link rel="stylesheet" href="./resources/qgis2web.css">
        <style>
        html, body {
            background-color: #ffffff;
        }
        .ol-control > * {
            background-color: #f8f8f8!important;
            color: #444444!important;
            border-radius: 0px;
        }
        .ol-attribution a, .gcd-gl-input::placeholder, .search-layer-input-search::placeholder {
            color: #444444!important;
        }
        .search-layer-input-search {
            background-color: #f8f8f8!important;
        }
        .ol-control > *:focus, .ol-control >*:hover {
            background-color: rgba(248, 248, 248, 0.7)!important;
        } 
        .ol-control {
            background-color: rgba(255,255,255,.4) !important;
            padding: 2px !important;
        } 
        </style>
        <style>
        html, body, #map {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }
        </style>
        <title>Budapest Districts + Population Radar</title>
    </head>
    <body>
        <!-- SINGLE Plotly panel - positioned over map -->
        <div id="plotly-panel" style="
            position:absolute;
            bottom:10px;
            right:10px;
            width:500px;
            height:400px;
            background:white;
            border:2px solid #444;
            z-index:1000;
            padding:8px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            ">
        </div>

        <!-- SINGLE map div -->
        <div id="map">
            <div id="popup" class="ol-popup">
                <a href="#" id="popup-closer" class="ol-popup-closer"></a>
                <div id="popup-content"></div>
            </div>
        </div>

        <!-- Plotly CDN -->
        <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
        
        <!-- All qgis2web scripts -->
        <script src="resources/qgis2web_expressions.js"></script>
        <script src="./resources/functions.js"></script>
        <script src="./resources/ol.js"></script>
        <script src="./resources/ol-layerswitcher.js"></script>
        <script src="layers/Kerletek_1.js"></script>
        <script src="layers/Budapest_2.js"></script>
        <script src="styles/Kerletek_1_style.js"></script>
        <script src="styles/Budapest_2_style.js"></script>
        <script src="./layers/layers.js" type="text/javascript"></script> 
        <script src="./resources/Autolinker.min.js"></script>
        <script src="./resources/qgis2web.js"></script>

        <!-- Your radar script - FIXED timing -->
             <!-- DYNAMIC radar - updates for visible districts -->
        <script>
        // Real data from your CSV [file:40]
        var districtData = [
          {name: 'I.', pop: 23685},
          {name: 'II.', pop: 86567},
          {name: 'III.', pop: 124746},
          {name: 'IV.', pop: 94391},
          {name: 'V.', pop: 21931},
          {name: 'VI.', pop: 35441},
          {name: 'VII.', pop: 48943},
          {name: 'VIII.', pop: 70048},
          {name: 'IX.', pop: 59588},
          {name: 'X.', pop: 75628},
          {name: 'XI.', pop: 141090},
          {name: 'XII.', pop: 57295},
          {name: 'XIII.', pop: 122973},
          {name: 'XIV.', pop: 118705},
          {name: 'XV.', pop: 77091},
          {name: 'XVI.', pop: 73270},
          {name: 'XVII.', pop: 84922},
          {name: 'XVIII.', pop: 99400},
          {name: 'XIX.', pop: 56507},
          {name: 'XX.', pop: 63512},
          {name: 'XXI.', pop: 70442},
          {name: 'XXII.', pop: 56534},
          {name: 'XXIII.', pop: 22633}
        ];

        function drawRadar(names, pops, title) {
          names.push(names[0]);
          pops.push(pops[0]);
          var data = [{
            type: 'scatterpolar',
            r: pops,
            theta: names,
            fill: 'toself',
            line: {color: '#2E8B57', width: 3},
            marker: {color: '#90EE90'}
          }];
          var layout = {
            title: title,
            font: {size: 14, family: 'Arial'},
            polar: {
              radialaxis: {visible: true, range: [0, 150000], tickvals: [50000, 100000]},
              bgcolor: 'rgba(248,255,248,0.9)'
            },
            margin: {l: 50, r: 50, t: 80, b: 50},
            showlegend: false,
            paper_bgcolor: 'rgba(255,255,255,0.98)'
          };
          Plotly.newPlot('plotly-panel', data, layout, {responsive: true});
        }

        // NEW: Get visible districts from map extent
        function updateVisibleRadar() {
          if (typeof map === 'undefined') {
            console.log('Map not ready yet');
            return;
          }

          var extent = map.getView().calculateExtent(map.getSize());
          console.log('Current extent:', extent);

          // Find Kerletek_1 layer (your districts)
          var keruletLayer = null;
          map.getLayers().forEach(function(layer) {
            if (layer.get('name') && layer.get('name').indexOf('Kerletek') >= 0) {
              keruletLayer = layer;
            }
          });

          if (!keruletLayer) {
            drawRadar(districtData.map(d => d.name), districtData.map(d => d.pop), 'Kerületek réteg nem található');
            return;
          }

          var source = keruletLayer.getSource();
          var visibleNames = [];
          var visiblePops = [];

          source.forEachFeature(function(feature) {
            if (feature.getGeometry().intersectsExtent(extent)) {
              var name = feature.get('Kerületszám') || feature.get('name') || 'N/A';
              var pop = parseInt(feature.get('Népesség(2022)[2]')) || 0;
              if (name && pop > 0) {
                visibleNames.push(name);
                visiblePops.push(pop);
              }
            }
          });

          if (visibleNames.length === 0) {
            drawRadar(['Nincs'], [0], 'Nincs látható kerület');
          } else {
            drawRadar(visibleNames, visiblePops, visibleNames.length + ' látható kerület népessége');
          }
        }

        // Wait longer for full map load, then hook events
        setTimeout(function() {
          if (typeof Plotly !== 'undefined' && typeof map !== 'undefined') {
            // Initial
            updateVisibleRadar();
            console.log('Dynamic radar ready!');

            // Update on pan/zoom
            map.on('moveend', updateVisibleRadar);
            
          } else {
            console.error('Map or Plotly missing');
          }
        }, 3000);
        </script>
    </body>
</html>
