<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Budapest Districts + Population Radar</title>
    <link rel="stylesheet" href="./resources/ol.css">
    <link rel="stylesheet" href="resources/fontawesome-all.min.css">
    <link rel="stylesheet" href="./resources/ol-layerswitcher.css">
    <link rel="stylesheet" href="./resources/qgis2web.css">
    <style>
      html, body, #map {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #plotly-panel {
        position:absolute;
        bottom:10px;
        right:10px;
        width:500px;
        height:400px;
        background:white;
        border:2px solid #444;
        z-index:1000;
        padding:8px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
      #barchart-panel {
        position:absolute;
        bottom:10px;
        left:10px;
        width:500px;
        height:300px;
        background:white;
        border:2px solid #444;
        z-index:1000;
        padding:8px;
        border-radius:8px;
        box-shadow:0 4px 8px rgba(0,0,0,0.2);
      }
    </style>
  </head>
  <body>
    <div id="plotly-panel"></div>
    <div id="barchart-panel"></div>
    <div id="tornado-panel" style="
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  width:600px;
  height:350px;
  background:white;
  border:2px solid #444;
  z-index:1000;
  padding:8px;
  border-radius:8px;
  box-shadow:0 4px 8px rgba(0,0,0,0.2);
"></div>


    <div id="map">
      <div id="popup" class="ol-popup">
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content"></div>
      </div>
    </div>

    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

    <!-- qgis2web / OL -->
    <script src="resources/qgis2web_expressions.js"></script>
    <script src="./resources/functions.js"></script>
    <script src="./resources/ol.js"></script>
    <script src="./resources/ol-layerswitcher.js"></script>
    <script src="layers/Kerletek_1.js"></script>
    <script src="layers/Budapest_2.js"></script>
    <script src="styles/Kerletek_1_style.js"></script>
    <script src="styles/Budapest_2_style.js"></script>
    <script src="./layers/layers.js"></script>
    <script src="./resources/Autolinker.min.js"></script>
    <script src="./resources/qgis2web.js"></script>

    <!-- Radar + bar logic -->
    <script>
    // CSV-based population + creation year
    const districtData = [
  { name: "I.",    pop: 23685, year: 1873, density: 6946 },
  { name: "II.",   pop: 86567, year: 1873, density: 2382 },
  { name: "III.",  pop: 124746,year: 1873, density: 3143 },
  { name: "IV.",   pop: 94391, year: 1950, density: 5015 },
  { name: "V.",    pop: 21931, year: 1873, density: 8468 },
  { name: "VI.",   pop: 35441, year: 1873, density: 14891 },
  { name: "VII.",  pop: 48943, year: 1873, density: 23418 },
  { name: "VIII.", pop: 70048, year: 1873, density: 10226 },
  { name: "IX.",   pop: 59588, year: 1873, density: 4756 },
  { name: "X.",    pop: 75628, year: 1873, density: 2328 },
  { name: "XI.",   pop: 141090,year: 1934, density: 4213 },
  { name: "XII.",  pop: 57295, year: 1940, density: 2148 },
  { name: "XIII.", pop: 122973,year: 1938, density: 9150 },
  { name: "XIV.",  pop: 118705,year: 1935, density: 6547 },
  { name: "XV.",   pop: 77091, year: 1950, density: 2862 },
  { name: "XVI.",  pop: 73270, year: 1950, density: 2187 },
  { name: "XVII.", pop: 84922, year: 1950, density: 1549 },
  { name: "XVIII.",pop: 99400, year: 1950, density: 2575 },
  { name: "XIX.",  pop: 56507, year: 1950, density: 6024 },
  { name: "XX.",   pop: 63512, year: 1950, density: 5210 },
  { name: "XXI.",  pop: 70442, year: 1950, density: 2736 },
  { name: "XXII.", pop: 56534, year: 1950, density: 1651 },
  { name: "XXIII.",pop: 22633, year: 1994, density: 555 }
];

function drawDensityTornado(visibleNames) {
  const div = document.getElementById('tornado-panel');
  if (!div) return;

  const rows = districtData.filter(d => visibleNames.includes(d.name));
  if (rows.length === 0) {
    Plotly.newPlot(div, [], {title:{text:'Népsűrűség – nincs látható kerület'}});
    return;
  }

  // sort by density
  rows.sort((a, b) => a.density - b.density);

  const labels = rows.map(r => r.name);
  const dens   = rows.map(r => r.density);

  // split low vs high around median for left/right tornado sides
  const midIdx = Math.floor(rows.length / 2);
  const leftRows  = rows.slice(0, midIdx);
  const rightRows = rows.slice(midIdx);

  const leftTrace = {
    type: 'bar',
    orientation: 'h',
    x: leftRows.map(r => -r.density),          // negative => left
    y: leftRows.map(r => r.name),
    text: leftRows.map(r => r.density.toString()),
    textposition: 'auto',
    name: 'Alacsonyabb népsűrűség',
    marker: { color: '#4361ee' }
  };

  const rightTrace = {
    type: 'bar',
    orientation: 'h',
    x: rightRows.map(r => r.density),          // positive => right
    y: rightRows.map(r => r.name),
    text: rightRows.map(r => r.density.toString()),
    textposition: 'auto',
    name: 'Magasabb népsűrűség',
    marker: { color: '#ff006e' }
  };

  const maxAbs = Math.max(
    ...rows.map(r => Math.abs(r.density))
  );

  const layout = {
    title: { text: 'Népsűrűség „tornado” (fő/km²)' },
    barmode: 'overlay',
    xaxis: {
      title: 'fő/km²',
      range: [-maxAbs * 1.1, maxAbs * 1.1],
      tickvals: [-maxAbs, -maxAbs/2, 0, maxAbs/2, maxAbs],
      ticktext: [maxAbs, maxAbs/2, 0, maxAbs/2, maxAbs] // show positive labels
    },
    margin: { t:40, l:60, r:20, b:40 }
  };

  Plotly.newPlot(div, [leftTrace, rightTrace], layout, {displayModeBar:false});
}

    function drawRadar(labels, values, titleText) {
  const div = document.getElementById('plotly-panel');

  if (!labels.length) {
    Plotly.newPlot(div, [], { title: { text: titleText } });
    return;
  }

  const minV = Math.min(...values);
  const maxV = Math.max(...values);

  const synth = ['#00f5d4', '#4361ee', '#7209b7', '#ff006e'];
  function colorForVal(v) {
    const t = (v - minV) / (maxV - minV || 1);
    const idx = Math.min(
      synth.length - 1,
      Math.floor(t * (synth.length - 1))
    );
    return synth[idx];
  }
  const markerColors = values.map(v => colorForVal(v));

  // Close the loop so the polygon is continuous
  const rClosed = values.concat(values[0]);
  const thetaClosed = labels.concat(labels[0]);

  const data = [{
    type: 'scatterpolar',
    r: rClosed,
    theta: thetaClosed,
    fill: 'toself',               // filled polygon
    fillcolor: 'rgba(255,0,110,0.25)', // semi‑transparent synthwave pink
    name: 'Population',
    marker: {
      size: 10,
      color: markerColors
    },
    line: {
      color: '#ff006e',
      width: 2
    }
  }];

  const layout = {
    title: { text: titleText },
    polar: { radialaxis: { visible: true } },
    margin: { t:40, l:30, r:30, b:30 }
  };

  Plotly.newPlot(div, data, layout, { displayModeBar: false });
}



    function drawBarChart(visibleNames) {
      const div = document.getElementById('barchart-panel');
      if (!div) return;

      const rows = districtData.filter(d => visibleNames.includes(d.name));
      if (rows.length === 0) return;

      const years = rows.map(r => r.year);
      const minY = Math.min(...years);
      const maxY = Math.max(...years);

  // Synthwave palette: teal → purple → pink → neon yellow
      const synthColors = [
        '#00f5d4', // neon teal
        '#4361ee', // electric blue
        '#7209b7', // purple
        '#ff006e', // hot pink
        '#ffbe0b'  // neon yellow
  ];

  function synthColorForYear(year) {
    const t = (year - minY) / (maxY - minY || 1); // 0..1
    const idx = Math.min(
      synthColors.length - 1,
      Math.floor(t * (synthColors.length - 1))
    );
    return synthColors[idx];
  }

  const colors = rows.map(r => synthColorForYear(r.year));

  const data = [{
    type: 'bar',
    x: rows.map(r => r.name),
    y: years,
    text: years.map(y => y.toString()),
    textposition: 'auto',
    marker: { color: colors }
  }];

  const layout = {
    title: { text: 'Létrehozás éve kerületenként' },
    yaxis: { title: 'Év', range: [1800, 2025] },
    margin: { t:40, l:40, r:20, b:40 }
  };

  Plotly.newPlot(div, data, layout, {displayModeBar:false});
}


    function updateVisibleKeruletek(evt) {
      if (!window.map) return;

      const m = evt && evt.map ? evt.map : map;
      const extent = m.getView().calculateExtent(m.getSize());
      console.log('EXTENT', extent);

      const keruletLayer = m.getLayers().getArray().find(l =>
        (l.get('name')  && l.get('name').toLowerCase().includes('kerlet')) ||
        (l.get('title') && l.get('title').toLowerCase().includes('kerlet'))
      );

      if (!keruletLayer) {
        console.warn('No kerület layer found, showing all districts.');
        const allNames = districtData.map(d => d.name);
        drawRadar(allNames, districtData.map(d=>d.pop),
                  'Kerületek réteg nem található');
        drawBarChart(allNames);
        return;
      }

      const source = keruletLayer.getSource();
      const allFeatures = source.getFeatures();
      console.log('FEATURE COUNT', allFeatures.length);

      const visible = [];

      allFeatures.forEach(f => {
        const geom = f.getGeometry();
        if (!geom || !geom.intersectsExtent(extent)) return;

        const kerStr = f.get('Városrés'); // "I.", "II.", ...

        if (!kerStr) return;

        const rec = districtData.find(d => d.name === kerStr);
        if (rec) {
          visible.push({ name: rec.name, pop: rec.pop });
        } else {
          console.log('NO MATCH IN districtData FOR', kerStr);
        }
      });

      if (visible.length === 0) {
        const demo = districtData.slice(0,5);
        const demoNames = demo.map(d=>d.name);
        drawRadar(
          demoNames,
          demo.map(d=>d.pop),
          'Nincs látható kerület – nagyíts Budapestre'
        );
        drawBarChart(demoNames);
      } else {
        const names = visible.map(v=>v.name);
        drawRadar(
          names,
          visible.map(v=>v.pop),
          `Látható kerületek lakossága (${visible.length})`
        );
        drawBarChart(names);
      }
    }
      if (visible.length === 0) {
  const demo = districtData.slice(0,5);
  const demoNames = demo.map(d=>d.name);
  drawRadar(
    demoNames,
    demo.map(d=>d.pop),
    'Nincs látható kerület – nagyíts Budapestre'
  );
  drawBarChart(demoNames);
  drawDensityTornado(demoNames);
} else {
  const names = visible.map(v=>v.name);
  drawRadar(
    names,
    visible.map(v=>v.pop),
    `Látható kerületek (${visible.length})`
  );
  drawBarChart(names);
  drawDensityTornado(names);
}


    // Wait for qgis2web map, then wire moveend
    window.addEventListener('load', function () {
      let tries = 0;
      const timer = setInterval(function () {
        tries++;
        if (window.map) {
          clearInterval(timer);
          updateVisibleKeruletek({map});          // initial render
          map.on('moveend', updateVisibleKeruletek); // update on pan/zoom
          console.log('moveend listener attached');
        } else if (tries > 20) {
          clearInterval(timer);
          console.error('map not found');
        }
      }, 300);
    });
    </script>
  </body>
</html>






