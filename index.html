<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Budapest Districts + Population Radar</title>
    <link rel="stylesheet" href="./resources/ol.css">
    <link rel="stylesheet" href="resources/fontawesome-all.min.css">
    <link rel="stylesheet" href="./resources/ol-layerswitcher.css">
    <link rel="stylesheet" href="./resources/qgis2web.css">
    <style>
      html, body, #map {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #plotly-panel {
        position:absolute;
        bottom:10px;
        right:10px;
        width:500px;
        height:400px;
        background:white;
        border:2px solid #444;
        z-index:1000;
        padding:8px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      }
    </style>
  </head>
  <body>
    <div id="plotly-panel"></div>

    <div id="map">
      <div id="popup" class="ol-popup">
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content"></div>
      </div>
    </div>

    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

    <!-- qgis2web / OL -->
    <script src="resources/qgis2web_expressions.js"></script>
    <script src="./resources/functions.js"></script>
    <script src="./resources/ol.js"></script>
    <script src="./resources/ol-layerswitcher.js"></script>
    <script src="layers/Kerletek_1.js"></script>
    <script src="layers/Budapest_2.js"></script>
    <script src="styles/Kerletek_1_style.js"></script>
    <script src="styles/Budapest_2_style.js"></script>
    <script src="./layers/layers.js"></script>
    <script src="./resources/Autolinker.min.js"></script>
    <script src="./resources/qgis2web.js"></script>

    <!-- Radar logic -->
    <script>
      // Example fallback data (you can extend this)
      const districtData = [
  { name: "I.",    pop: 23685 },
  { name: "II.",   pop: 86567 },
  { name: "III.",  pop: 124746 },
  { name: "IV.",   pop: 94391 },
  { name: "V.",    pop: 21931 },
  { name: "VI.",   pop: 35441 },
  { name: "VII.",  pop: 48943 },
  { name: "VIII.", pop: 70048 },
  { name: "IX.",   pop: 59588 },
  { name: "X.",    pop: 75628 },
  { name: "XI.",   pop: 141090 },
  { name: "XII.",  pop: 57295 },
  { name: "XIII.", pop: 122973 },
  { name: "XIV.",  pop: 118705 },
  { name: "XV.",   pop: 77091 },
  { name: "XVI.",  pop: 73270 },
  { name: "XVII.", pop: 84922 },
  { name: "XVIII.",pop: 99400 },
  { name: "XIX.",  pop: 56507 },
  { name: "XX.",   pop: 63512 },
  { name: "XXI.",  pop: 70442 },
  { name: "XXII.", pop: 56534 },
  { name: "XXIII.",pop: 22633 }
];


      function drawRadar(labels, values, titleText) {
        const div = document.getElementById('plotly-panel');
        const data = [{
          type: 'scatterpolar',
          r: values,
          theta: labels,
          fill: 'toself',
          name: 'Population'
        }];
        const layout = {
          title: { text: titleText },
          polar: { radialaxis: { visible: true } },
          margin: { t:40, l:30, r:30, b:30 }
        };
        Plotly.newPlot(div, data, layout, {displayModeBar: false});
      }

      function drawDebug(titleText, msg) {
        drawRadar(['Info'], [1], titleText + '\n' + msg);
      }

      function updateVisibleKeruletek() {
        try {
          if (!window.map) throw 'No map';

          const extent = map.getView().calculateExtent(map.getSize());

          const keruletLayer = map.getLayers().getArray().find(l =>
            (l.get('name')  && l.get('name').toLowerCase().includes('kerlet')) ||
            (l.get('title') && l.get('title').toLowerCase().includes('kerlet'))
          );

          if (!keruletLayer) {
            drawRadar(districtData.map(d=>d.name), districtData.map(d=>d.pop),
                      'Kerületek réteg nem található');
            return;
          }

          const source = keruletLayer.getSource();
          const allFeatures = source.getFeatures();
          const visible = [];

          allFeatures.forEach(f => {
            const geom = f.getGeometry();
            if (geom && geom.intersectsExtent(extent)) {
              const name = f.get('Kerületszám') || f.get('name') ||
                           f.get('kerület') || f.get('Kerület') || 'N/A';
              const popField = f.get('Népesség(2022)[2]') || f.get('Népesség') ||
                               f.get('population') || f.get('pop');
              const pop = parseInt(popField) || 0;
              if (name !== 'N/A' && pop > 0) visible.push({name, pop});
            }
          });

          if (visible.length === 0) {
            const demo = districtData.slice(0, 5);
            drawRadar(demo.map(d=>d.name), demo.map(d=>d.pop),
                      'Nincs látható kerület – demo');
          } else {
            drawRadar(
              visible.map(v=>v.name),
              visible.map(v=>v.pop),
              `Látható kerületek (${visible.length})`
            );
          }
        } catch (e) {
          console.error(e);
          drawRadar(['Hiba'], [0], 'Hiba – F12 Console');
        }
      }

      // Wait for qgis2web to finish creating "map", then init radar once and attach listeners
      window.addEventListener('load', function () {
        const MAX_TRIES = 20;
        let tries = 0;
        const timer = setInterval(function () {
          tries++;
          if (window.map) {
            clearInterval(timer);
            // initial plot
            updateVisibleKeruletek();
            // update on move
            map.on('moveend', updateVisibleKeruletek);
          } else if (tries > MAX_TRIES) {
            clearInterval(timer);
            drawDebug('❌ NO MAP', 'map object not found');
          }
        }, 300);
      });
    </script>
  </body>
</html>

